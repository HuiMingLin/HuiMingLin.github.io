<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>结构型模式 | Ryan Lin 的知识库</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.2257f275.css" as="style"><link rel="preload" href="/assets/js/app.01dca14b.js" as="script"><link rel="preload" href="/assets/js/2.bffc4eaa.js" as="script"><link rel="preload" href="/assets/js/29.15ed9b47.js" as="script"><link rel="prefetch" href="/assets/js/10.a7d2ff8b.js"><link rel="prefetch" href="/assets/js/100.bf5ad1db.js"><link rel="prefetch" href="/assets/js/101.696a3a19.js"><link rel="prefetch" href="/assets/js/102.96dc7b3a.js"><link rel="prefetch" href="/assets/js/103.868cd415.js"><link rel="prefetch" href="/assets/js/104.ba58fa0f.js"><link rel="prefetch" href="/assets/js/105.3a1afd2a.js"><link rel="prefetch" href="/assets/js/106.86159b3c.js"><link rel="prefetch" href="/assets/js/107.f1fea0ee.js"><link rel="prefetch" href="/assets/js/108.90925b19.js"><link rel="prefetch" href="/assets/js/109.78b14382.js"><link rel="prefetch" href="/assets/js/11.e6377cb0.js"><link rel="prefetch" href="/assets/js/110.09a7eb30.js"><link rel="prefetch" href="/assets/js/111.04503484.js"><link rel="prefetch" href="/assets/js/112.6bcbe037.js"><link rel="prefetch" href="/assets/js/113.5af43a08.js"><link rel="prefetch" href="/assets/js/114.c8630245.js"><link rel="prefetch" href="/assets/js/115.ad2dcb6a.js"><link rel="prefetch" href="/assets/js/116.265d462b.js"><link rel="prefetch" href="/assets/js/117.1c317fad.js"><link rel="prefetch" href="/assets/js/118.2c7e0d59.js"><link rel="prefetch" href="/assets/js/119.7e7fba56.js"><link rel="prefetch" href="/assets/js/12.5f4a0a34.js"><link rel="prefetch" href="/assets/js/120.9590eb76.js"><link rel="prefetch" href="/assets/js/121.646e0d90.js"><link rel="prefetch" href="/assets/js/122.bbdd9f96.js"><link rel="prefetch" href="/assets/js/123.8beaa67f.js"><link rel="prefetch" href="/assets/js/124.3e64e6f2.js"><link rel="prefetch" href="/assets/js/13.c9181e61.js"><link rel="prefetch" href="/assets/js/14.9c10d691.js"><link rel="prefetch" href="/assets/js/15.6ef82dc2.js"><link rel="prefetch" href="/assets/js/16.ba41a7fe.js"><link rel="prefetch" href="/assets/js/17.4e0d365d.js"><link rel="prefetch" href="/assets/js/18.dbef3ad9.js"><link rel="prefetch" href="/assets/js/19.447dfdb1.js"><link rel="prefetch" href="/assets/js/20.1bae5a83.js"><link rel="prefetch" href="/assets/js/21.64f1b587.js"><link rel="prefetch" href="/assets/js/22.4f604c63.js"><link rel="prefetch" href="/assets/js/23.56a828b3.js"><link rel="prefetch" href="/assets/js/24.4d6c3c58.js"><link rel="prefetch" href="/assets/js/25.f869f58d.js"><link rel="prefetch" href="/assets/js/26.a865f231.js"><link rel="prefetch" href="/assets/js/27.cdee9932.js"><link rel="prefetch" href="/assets/js/28.6736c794.js"><link rel="prefetch" href="/assets/js/3.fc924ce8.js"><link rel="prefetch" href="/assets/js/30.d107cd89.js"><link rel="prefetch" href="/assets/js/31.8f0a0dd2.js"><link rel="prefetch" href="/assets/js/32.7235a49a.js"><link rel="prefetch" href="/assets/js/33.dd2c72c9.js"><link rel="prefetch" href="/assets/js/34.9aea08e8.js"><link rel="prefetch" href="/assets/js/35.0f348c2a.js"><link rel="prefetch" href="/assets/js/36.b7d24b5c.js"><link rel="prefetch" href="/assets/js/37.50093425.js"><link rel="prefetch" href="/assets/js/38.45e17237.js"><link rel="prefetch" href="/assets/js/39.b41a2385.js"><link rel="prefetch" href="/assets/js/4.bd730c56.js"><link rel="prefetch" href="/assets/js/40.e29a13f8.js"><link rel="prefetch" href="/assets/js/41.e150569e.js"><link rel="prefetch" href="/assets/js/42.b97dfe0c.js"><link rel="prefetch" href="/assets/js/43.70701a88.js"><link rel="prefetch" href="/assets/js/44.2397f2b3.js"><link rel="prefetch" href="/assets/js/45.460151bd.js"><link rel="prefetch" href="/assets/js/46.8261fe42.js"><link rel="prefetch" href="/assets/js/47.08af9e05.js"><link rel="prefetch" href="/assets/js/48.c4964331.js"><link rel="prefetch" href="/assets/js/49.4e7b29c5.js"><link rel="prefetch" href="/assets/js/5.6b60ba93.js"><link rel="prefetch" href="/assets/js/50.d218943b.js"><link rel="prefetch" href="/assets/js/51.b4eb6236.js"><link rel="prefetch" href="/assets/js/52.bdbaa4b9.js"><link rel="prefetch" href="/assets/js/53.69555214.js"><link rel="prefetch" href="/assets/js/54.602e3c97.js"><link rel="prefetch" href="/assets/js/55.6b4a40ce.js"><link rel="prefetch" href="/assets/js/56.3bede644.js"><link rel="prefetch" href="/assets/js/57.86ebd958.js"><link rel="prefetch" href="/assets/js/58.318f659d.js"><link rel="prefetch" href="/assets/js/59.fc0a8da8.js"><link rel="prefetch" href="/assets/js/6.e9b450da.js"><link rel="prefetch" href="/assets/js/60.2477f572.js"><link rel="prefetch" href="/assets/js/61.47f7ed8a.js"><link rel="prefetch" href="/assets/js/62.aaba17ef.js"><link rel="prefetch" href="/assets/js/63.78b23178.js"><link rel="prefetch" href="/assets/js/64.032d43cd.js"><link rel="prefetch" href="/assets/js/65.a3f173e2.js"><link rel="prefetch" href="/assets/js/66.5a5bb13c.js"><link rel="prefetch" href="/assets/js/67.9354579b.js"><link rel="prefetch" href="/assets/js/68.73d8d590.js"><link rel="prefetch" href="/assets/js/69.2ff131cf.js"><link rel="prefetch" href="/assets/js/7.e01fde56.js"><link rel="prefetch" href="/assets/js/70.c4988b34.js"><link rel="prefetch" href="/assets/js/71.60f13cc5.js"><link rel="prefetch" href="/assets/js/72.538df216.js"><link rel="prefetch" href="/assets/js/73.8352279e.js"><link rel="prefetch" href="/assets/js/74.1cc346c3.js"><link rel="prefetch" href="/assets/js/75.46cbc52d.js"><link rel="prefetch" href="/assets/js/76.8475b536.js"><link rel="prefetch" href="/assets/js/77.a6a02523.js"><link rel="prefetch" href="/assets/js/78.8bc5a5aa.js"><link rel="prefetch" href="/assets/js/79.82d676d6.js"><link rel="prefetch" href="/assets/js/8.715e5aa4.js"><link rel="prefetch" href="/assets/js/80.e05e720e.js"><link rel="prefetch" href="/assets/js/81.4da01b56.js"><link rel="prefetch" href="/assets/js/82.ac9333b4.js"><link rel="prefetch" href="/assets/js/83.82ec9e31.js"><link rel="prefetch" href="/assets/js/84.7bf2bc77.js"><link rel="prefetch" href="/assets/js/85.6a450a07.js"><link rel="prefetch" href="/assets/js/86.582abcee.js"><link rel="prefetch" href="/assets/js/87.4f8b2fa8.js"><link rel="prefetch" href="/assets/js/88.daf8f4cf.js"><link rel="prefetch" href="/assets/js/89.f608d75d.js"><link rel="prefetch" href="/assets/js/9.81357d9e.js"><link rel="prefetch" href="/assets/js/90.b529ea18.js"><link rel="prefetch" href="/assets/js/91.509c6a84.js"><link rel="prefetch" href="/assets/js/92.8da5af98.js"><link rel="prefetch" href="/assets/js/93.24c9dad0.js"><link rel="prefetch" href="/assets/js/94.a9bbc569.js"><link rel="prefetch" href="/assets/js/95.c7eaaf57.js"><link rel="prefetch" href="/assets/js/96.4fbad82e.js"><link rel="prefetch" href="/assets/js/97.bca647b9.js"><link rel="prefetch" href="/assets/js/98.1e365441.js"><link rel="prefetch" href="/assets/js/99.cbf99e7a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2257f275.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.jpg" alt="Ryan Lin 的知识库" class="logo"> <span class="site-name can-hide">Ryan Lin 的知识库</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  关于我
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Typescript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NodeJs</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>C++</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微前端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>同构</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>serverless</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>移动端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>桌面端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Monorepo</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Chrome</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DevOps</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>流程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>灰度</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>监控</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>部署</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>发布</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/design-patterns/origin" class="sidebar-heading clickable open"><span>设计模式</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/design-patterns/behavioral-type/behavioral-type.html" class="sidebar-link">行为型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#责任链模式-职责链" class="sidebar-link">责任链模式 (职责链)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#现实中的职责链模式" class="sidebar-link">现实中的职责链模式</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#实际开发中的职责链模式" class="sidebar-link">实际开发中的职责链模式</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#用职责链模式重构代码" class="sidebar-link">用职责链模式重构代码</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#灵活可拆分的职责链节点" class="sidebar-link">灵活可拆分的职责链节点</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#异步的职责链" class="sidebar-link">异步的职责链</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#职责链模式的优缺点" class="sidebar-link">职责链模式的优缺点</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#用-aop-实现职责链" class="sidebar-link">用 AOP 实现职责链</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#用职责链模式获取文件上传对象" class="sidebar-link">用职责链模式获取文件上传对象</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#小结" class="sidebar-link">小结</a></li></ul></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#命令模式" class="sidebar-link">命令模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#javascript-中的命令模式" class="sidebar-link">JavaScript 中的命令模式</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#撤销命令" class="sidebar-link">撤销命令</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#撤销和重做" class="sidebar-link">撤销和重做</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#命令队列" class="sidebar-link">命令队列</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#宏命令" class="sidebar-link">宏命令</a></li></ul></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#解释器模式" class="sidebar-link">解释器模式</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#迭代器模式" class="sidebar-link">迭代器模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#_1、实现自己的迭代器" class="sidebar-link">1、实现自己的迭代器</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#_2、内部迭代器和外部迭代器" class="sidebar-link">2、内部迭代器和外部迭代器</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#_3、迭代类数组对象和字面量对象" class="sidebar-link">3、迭代类数组对象和字面量对象</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#_4、倒序迭代器" class="sidebar-link">4、倒序迭代器</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#_5、中止迭代器" class="sidebar-link">5、中止迭代器</a></li></ul></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#中介者模式" class="sidebar-link">中介者模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#现实中的中介者" class="sidebar-link">现实中的中介者</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#中介者模式的例子-泡泡堂游戏" class="sidebar-link">中介者模式的例子——泡泡堂游戏</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#小结-2" class="sidebar-link">小结</a></li></ul></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#备忘录模式" class="sidebar-link">备忘录模式</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#观察者模式-发布-订阅模式" class="sidebar-link">观察者模式 （发布—订阅模式）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#dom-事件" class="sidebar-link">DOM 事件</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#发布-订阅模式的通用实现" class="sidebar-link">发布-订阅模式的通用实现</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#真实的例子-网站登录" class="sidebar-link">真实的例子——网站登录</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#全局的发布-订阅对象" class="sidebar-link">全局的发布-订阅对象</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#必须先订阅再发布吗" class="sidebar-link">必须先订阅再发布吗</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#全局事件的命名冲突" class="sidebar-link">全局事件的命名冲突</a></li></ul></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#状态模式" class="sidebar-link">状态模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#初识状态模式" class="sidebar-link">初识状态模式</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#第一个例子-电灯程序" class="sidebar-link">第一个例子:电灯程序</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#状态模式改进电灯程序" class="sidebar-link">状态模式改进电灯程序</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#状态模式的定义" class="sidebar-link">状态模式的定义</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#状态模式的通用结构" class="sidebar-link">状态模式的通用结构</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#缺少抽象类的变通方式" class="sidebar-link">缺少抽象类的变通方式</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#另一个状态模式示例-文件上传" class="sidebar-link">另一个状态模式示例——文件上传</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#更复杂的切换条件" class="sidebar-link">更复杂的切换条件</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#一些准备工作" class="sidebar-link">一些准备工作</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#开始编写代码" class="sidebar-link">开始编写代码</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#状态模式重构文件上传程序" class="sidebar-link">状态模式重构文件上传程序</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#状态模式的优缺点" class="sidebar-link">状态模式的优缺点</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#状态模式中的性能优化点" class="sidebar-link">状态模式中的性能优化点</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#状态模式和策略模式的关系" class="sidebar-link">状态模式和策略模式的关系</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#javascript-版本的状态机" class="sidebar-link">JavaScript 版本的状态机</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#表驱动的有限状态机" class="sidebar-link">表驱动的有限状态机</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#实际项目中的其他状态机" class="sidebar-link">实际项目中的其他状态机</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#小结-3" class="sidebar-link">小结</a></li></ul></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#空对象模式" class="sidebar-link">空对象模式</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#策略模式" class="sidebar-link">策略模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#javascript-版本的策略模式" class="sidebar-link">JavaScript 版本的策略模式</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#策略模式优缺点" class="sidebar-link">策略模式优缺点</a></li></ul></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#模板模式" class="sidebar-link">模板模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#抽象方法和具体方法" class="sidebar-link">抽象方法和具体方法</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#javascript-没有抽象类的缺点和解决方案" class="sidebar-link">JavaScript 没有抽象类的缺点和解决方案</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#模板方法模式的使用场景" class="sidebar-link">模板方法模式的使用场景</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#钩子方法" class="sidebar-link">钩子方法</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#好莱坞原则" class="sidebar-link">好莱坞原则</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#真的需要-继承-吗" class="sidebar-link">真的需要“继承”吗</a></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#小结-4" class="sidebar-link">小结</a></li></ul></li><li class="sidebar-sub-header"><a href="/design-patterns/behavioral-type/behavioral-type.html#访问者模式" class="sidebar-link">访问者模式</a></li></ul></li><li><a href="/design-patterns/creation-type/creation-type.html" class="sidebar-link">创建型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design-patterns/creation-type/creation-type.html#单例模式" class="sidebar-link">单例模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design-patterns/creation-type/creation-type.html#_1、实现单例模式" class="sidebar-link">1、实现单例模式</a></li><li class="sidebar-sub-header"><a href="/design-patterns/creation-type/creation-type.html#_2、用代理实现单例模式" class="sidebar-link">2、用代理实现单例模式</a></li><li class="sidebar-sub-header"><a href="/design-patterns/creation-type/creation-type.html#_3、javascript-中的单例模式" class="sidebar-link">3、JavaScript 中的单例模式</a></li><li class="sidebar-sub-header"><a href="/design-patterns/creation-type/creation-type.html#_4、惰性单例" class="sidebar-link">4、惰性单例</a></li></ul></li><li class="sidebar-sub-header"><a href="/design-patterns/creation-type/creation-type.html#原型模式-原型" class="sidebar-link">原型模式 （原型）</a></li></ul></li><li><a href="/design-patterns/structural-type/structural-type.html" aria-current="page" class="active sidebar-link">结构型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#适配器模式" class="sidebar-link">适配器模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#现实中的适配器" class="sidebar-link">现实中的适配器</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#适配器模式的应用" class="sidebar-link">适配器模式的应用</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#小结" class="sidebar-link">小结</a></li></ul></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#桥接模式" class="sidebar-link">桥接模式</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#过滤器模式" class="sidebar-link">过滤器模式</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#组合模式" class="sidebar-link">组合模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#请求在树中传递的过程" class="sidebar-link">请求在树中传递的过程</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#更强大的宏命令" class="sidebar-link">更强大的宏命令</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#透明性带来的安全问题" class="sidebar-link">透明性带来的安全问题</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#组合模式的例子-扫描文件夹" class="sidebar-link">组合模式的例子——扫描文件夹</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#一些值得注意的地方" class="sidebar-link">一些值得注意的地方</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#引用父对象" class="sidebar-link">引用父对象</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#何时使用组合模式" class="sidebar-link">何时使用组合模式</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#小结-2" class="sidebar-link">小结</a></li></ul></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#装饰器模式" class="sidebar-link">装饰器模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#装饰者也是包装器" class="sidebar-link">装饰者也是包装器</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#插件式的表单验证" class="sidebar-link">插件式的表单验证</a></li></ul></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#外观模式" class="sidebar-link">外观模式</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#享元模式" class="sidebar-link">享元模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#初识享元模式" class="sidebar-link">初识享元模式</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#内部状态和外部状态" class="sidebar-link">内部状态和外部状态</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#享元模式的通用结构" class="sidebar-link">享元模式的通用结构</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#文件上传的例子" class="sidebar-link">文件上传的例子</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#再谈内部状态和外部状态" class="sidebar-link">再谈内部状态和外部状态</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#没有内部状态的享元" class="sidebar-link">没有内部状态的享元</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#没有外部状态的享元" class="sidebar-link">没有外部状态的享元</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#对象池" class="sidebar-link">对象池</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#小结-3" class="sidebar-link">小结</a></li></ul></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#代理模式" class="sidebar-link">代理模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#保护代理和虚拟代理" class="sidebar-link">保护代理和虚拟代理</a></li><li class="sidebar-sub-header"><a href="/design-patterns/structural-type/structural-type.html#小结-4" class="sidebar-link">小结</a></li></ul></li></ul></li><li><a href="/design-patterns/j2ee/j2ee.html" class="sidebar-link">j2ee</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构与算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>调试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>测试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>文档管理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程范式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中国近代史纲要</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>马克思主义基本原理概述</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="结构型模式"><a href="#结构型模式" class="header-anchor">#</a> 结构型模式</h1> <p>结构型模式的目的就是封装对象之间的组合关系</p> <p>这些设计模式关注类和对象的组合。继承的概念被用来组合接口和定义组合对象获得新功能的方式。</p> <ul><li><a href="pages-design-patterns-structural-type-structural-type#%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F">适配器模式（Adapter Pattern）</a></li> <li><a href="pages-design-patterns-structural-type-structural-type#%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F">桥接模式（Bridge Pattern）</a></li> <li><a href="pages-design-patterns-structural-type-structural-type#%E8%BF%87%E6%BB%A4%E5%99%A8%E6%A8%A1%E5%BC%8F">过滤器模式（Filter、Criteria Pattern）</a></li> <li><a href="pages-design-patterns-structural-type-structural-type#%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F">组合模式（Composite Pattern）</a></li> <li><a href="pages-design-patterns-structural-type-structural-type#%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F">装饰器模式（Decorator Pattern）</a></li> <li><a href="pages-design-patterns-structural-type-structural-type#%E5%A4%96%E8%A7%82%E6%A8%A1%E5%BC%8F">外观模式（Facade Pattern）</a></li> <li><a href="pages-design-patterns-structural-type-structural-type#%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F">享元模式（Flyweight Pattern）</a></li> <li><a href="pages-design-patterns-structural-type-structural-type#%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F">代理模式（Proxy Pattern）</a></li></ul> <h2 id="适配器模式"><a href="#适配器模式" class="header-anchor">#</a> 适配器模式</h2> <p>适配器模式的作用是解决两个软件实体间的接口不兼容的问题。使用适配器模式之后，原本 由于接口不兼容而不能工作的两个软件实体可以一起工作。</p> <p>适配器的别名是包装器(wrapper)，这是一个相对简单的模式。
在程序开发中有许多这样的 场景: 当我们试图调用模块或者对象的某个接口时，却发现这个接口的格式并不符合目前的需求。
这时候有两种解决办法：</p> <p>第一种是修改原来的接口实现，但如果原来的模块很复杂，或者我们拿到的模块是一段别人编写的经过压缩的代码，修改原接口就显得不太现实了。</p> <p>第二种办法是创建一个适配器，将原接口转换为客户希望的另一个接口，客户只需要和适配器打交道。</p> <h3 id="现实中的适配器"><a href="#现实中的适配器" class="header-anchor">#</a> 现实中的适配器</h3> <p>适配器在现实生活的应用非常广泛，接下来我们来看几个现实生活中的适配器模式。</p> <ul><li><ol><li>港式插头转换器</li></ol></li></ul> <p>港式的电器插头比大陆的电器插头体积要大一些。如果从香港买了一个 Mac book，我们会发现充电器无法插在家里的插座上，
为此而改造家里的插座显然不方便，所以我们需要一个适配器:</p> <ul><li><ol start="2"><li>电源适配器</li></ol></li></ul> <p>Mac book 电池支持的电压是 20V，我们日常生活中的交流电压一般是 220V。
除了我们了解的 220V 交流电压，日本和韩国的交流电压大多是 100V，而英国和澳大利亚的是 240V。
笔记本电脑的电源适配器就承担了转换电压的作用，电源适配器使笔记本电脑在 100V~240V 的电压之内都能正常工作，
这也是它为什么被称为电源“适配器”的原因。</p> <ul><li><ol start="3"><li>USB 转接口
在以前的电脑上，PS2 接口是连接鼠标、键盘等其他外部设备的标准接口。
但随着技术的发展，越来越多的电脑开始放弃了 PS2 接口，转而仅支持 USB 接口。
所以那些过去生产出来的只拥有 PS2 接口的鼠标、键盘、游戏手柄等，需要一个 USB 转接口才能继续正常工作，这是 PS2-USB 适配器诞生的原因。</li></ol></li></ul> <h3 id="适配器模式的应用"><a href="#适配器模式的应用" class="header-anchor">#</a> 适配器模式的应用</h3> <p>如果现有的接口已经能够正常工作，那我们就永远不会用上适配器模式。
适配器模式是一种 “亡羊补牢”的模式，没有人会在程序的设计之初就使用它。因为没有人可以完全预料到未来的事情，
也许现在好好工作的接口，未来的某天却不再适用于新系统，那么我们可以用适配器模式把旧接口包装成一个新的接口，使它继续保持生命力。</p> <p>假设我们正在编写一个渲染广东省地图的页面。目前从第三方资源 里获得了广东省的所有城市以及它们所对应的 ID，并且成功地渲染到页面中:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> <span class="token function-variable function">getGuangdongCity</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> guangdongCity <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">&quot;shenzhen&quot;</span><span class="token punctuation">,</span>
        id<span class="token operator">:</span> <span class="token number">11</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">&quot;guangzhou&quot;</span><span class="token punctuation">,</span>
        id<span class="token operator">:</span> <span class="token number">12</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> guangdongCity<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;开始渲染广东省地图&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span>getGuangdongCity<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>利用这些数据，我们编写完成了整个页面，并且在线上稳定地运行了一段时间。但后来发现 这些数据不太可靠，里面还缺少很多城市。
于是我们又在网上找到了另外一些数据资源，这次的 数据更加全面，但遗憾的是，数据结构和正运行在项目中的并不一致。新的数据结构如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> guangdongCity <span class="token operator">=</span> <span class="token punctuation">{</span> 
    shenzhen<span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span> 
    guangzhou<span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span> 
    zhuhai<span class="token operator">:</span> <span class="token number">13</span> 
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>除了大动干戈地改写渲染页面的前端代码之外，另外一种更轻便的解决方式就是新增一个数 据格式转换的适配器:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> <span class="token function-variable function">getGuangdongCity</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> guangdongCity <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">&quot;shenzhen&quot;</span><span class="token punctuation">,</span>
        id<span class="token operator">:</span> <span class="token number">11</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">&quot;guangzhou&quot;</span><span class="token punctuation">,</span>
        id<span class="token operator">:</span> <span class="token number">12</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> guangdongCity<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;开始渲染广东省地图&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> <span class="token function-variable function">addressAdapter</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">oldAddressfn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> address <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      oldAddress <span class="token operator">=</span> <span class="token function">oldAddressfn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">;</span> <span class="token punctuation">(</span>c <span class="token operator">=</span> oldAddress<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      address<span class="token punctuation">[</span>c<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> address<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token function">addressAdapter</span><span class="token punctuation">(</span>getGuangdongCity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>那么接下来需要做的，就是把代码中调用 getGuangdongCity 的地方，用经过 addressAdapter 适配器转换之后的新函数来代替。</p> <h3 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h3> <p>适配器模式是一对相对简单的模式。在本书提到的设计模式中，有一些模式跟适配器模式的结构非常相似，
比如装饰者模式、代理模式和外观模式。这几种模式都属于“包装模式”，都是由一个对象来包装另一个对象。
区别它们的关键仍然是模式的意图。</p> <ul><li>适配器模式主要用来解决两个已有接口之间不匹配的问题，它不考虑这些接口是怎样实现的，也不考虑它们将来可能会如何演化。
适配器模式不需要改变已有的接口，就能够使它们协同作用。</li> <li>装饰者模式和代理模式也不会改变原有对象的接口，但装饰者模式的作用是为了给对象增加功能。
装饰者模式常常形成一条长的装饰链，而适配器模式通常只包装一次。代理模式是为了控制对对象的访问，通常也只包装一次。</li> <li>外观模式的作用倒是和适配器比较相似，有人把外观模式看成一组对象的适配器，但外观模式最显著的特点是定义了一个新的接口。</li></ul> <h2 id="桥接模式"><a href="#桥接模式" class="header-anchor">#</a> 桥接模式</h2> <h2 id="过滤器模式"><a href="#过滤器模式" class="header-anchor">#</a> 过滤器模式</h2> <h2 id="组合模式"><a href="#组合模式" class="header-anchor">#</a> 组合模式</h2> <p>组合模式将对象组合成树形结构，以表示“部分-整体”的层次结构。 除了用来表示树形结构之外，
组合模式的另一个好处是通过对象的多态性表现，使得用户对单个对象和组合对象的使 用具有一致性，下面分别说明。</p> <ul><li>组合模式的一个优点: 提供了一种遍历树形结构的方案，通过调用组合对象的 execute 方法，程序会递归调用组合对象下面的叶对象的 execute 方法，
所以我们的万能遥控器只需要一次操作，便能依次完成关门、 打开电脑、登录 QQ 这几件事情。
组合模式可以非常方便地描述对象部分  整体层次结构。</li> <li>利用对象多态性统一对待组合对象和单个对象。利用对象的多态性表现，可以使客户端 忽略组合对象和单个对象的不同。
在组合模式中，客户将统一地使用组合结构中的所有对象，而不需要关心它究竟是组合对象还是单个对象。</li></ul> <p>这在实际开发中会给客户带来相当大的便利性，当我们往万能遥控器里面添加一个命令的时候，并不关心这个命令是宏命令还是普通子命令。
这点对于我们不重要，我们只需要确定它是一 个命令，并且这个命令拥有可执行的 execute 方法，那么这个命令就可以被添加进万能遥控器。</p> <p>当宏命令和普通子命令接收到执行 execute 方法的请求时，宏命令和普通子命令都会做它们各自认为正确的事情。
这些差异是隐藏在客户背后的，在客户看来，这种透明性可以让我们非常自由地扩展这个万能遥控器。</p> <h3 id="请求在树中传递的过程"><a href="#请求在树中传递的过程" class="header-anchor">#</a> 请求在树中传递的过程</h3> <p>在组合模式中，请求在树中传递的过程总是遵循一种逻辑。</p> <p>以宏命令为例，请求从树最顶端的对象往下传递，如果当前处理请求的对象是叶对象(普通子命令)，
叶对象自身会对请求作出相应的处理;如果当前处理请求的对象是组合对象(宏命令)，
组合对象则会遍历它属下的子节点，将请求继续传递给这些子节点。</p> <p>总而言之，如果子节点是叶对象，叶对象自身会处理这个请求，而如果子节点还是组合对象，
请求会继续往下传递。叶对象下面不会再有其他子节点，一个叶对象就是树的这条枝叶的尽头，
组合对象下面可能还会有子节点。</p> <p><img src="/assets/images/combination.jpg" alt=""></p> <p>请求从上到下沿着树进行传递，直到树的尽头。作为客户，只需要关心树最顶层的组合对象，
客户只需要请求这个组合对象，请求便会沿着树往下传递，依次到达所有的叶对象。</p> <p>在刚刚的例子中，由于宏命令和子命令组成的树太过简单，我们还不能清楚地看到组合模式带来的好处，
如果只是简单地遍历一组子节点，迭代器便能解决所有的问题。
接下来我们将创造 一个更强大的宏命令，这个宏命令中又包含了另外一些宏命令和普通子命令，看起来是一棵相对较复杂的树。</p> <h3 id="更强大的宏命令"><a href="#更强大的宏命令" class="header-anchor">#</a> 更强大的宏命令</h3> <p>目前的万能遥控器，包含了关门、开电脑、登录 QQ 这 3 个命令。现在我们需要一个“超级
万能遥控器”，可以控制家里所有的电器，这个遥控器拥有以下功能:</p> <ul><li>打开空调</li> <li>打开电视和音响</li> <li>关门、开电脑、登录 QQ</li></ul> <p>首先在节点中放置一个按钮 button 来表示这个超级万能遥控器，超级万能遥控器上安装了一个宏命令，
当执行这个宏命令时，会依次遍历执行它所包含的子命令，代码如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token operator">&lt;</span>button id<span class="token operator">=</span><span class="token string">&quot;button&quot;</span><span class="token operator">&gt;</span>按我<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>

  <span class="token keyword">var</span> <span class="token function-variable function">MacroCommand</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token punctuation">{</span>
      commandsList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">command</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>commandsList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">execute</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> command<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>command <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commandsList<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> openAcCommand <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">execute</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;打开空调&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/**********家里的电视和音响是连接在一起的，所以可以用一个宏命令来组合打开电视和打开音响的命令 *********/</span>

  <span class="token keyword">var</span> openTvCommand <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">execute</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;打开电视&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> openSoundCommand <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">execute</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;打开音响&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> macroCommand1 <span class="token operator">=</span> <span class="token function">MacroCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  macroCommand1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>openTvCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>
  macroCommand1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>openSoundCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/*********关门、打开电脑和打登录 QQ 的命令****************/</span>

  <span class="token keyword">var</span> closeDoorCommand <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">execute</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;关门&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> openPcCommand <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">execute</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;开电脑&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> openQQCommand <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">execute</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;登录 QQ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> macroCommand2 <span class="token operator">=</span> <span class="token function">MacroCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  macroCommand2<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>closeDoorCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>
  macroCommand2<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>openPcCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>
  macroCommand2<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>openQQCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/*********现在把所有的命令组合成一个“超级命令”**********/</span>

  <span class="token keyword">var</span> macroCommand <span class="token operator">=</span> <span class="token function">MacroCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  macroCommand<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>openAcCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>
  macroCommand<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>macroCommand1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  macroCommand<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>macroCommand2<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/*********最后给遥控器绑定“超级命令”**********/</span>

  <span class="token keyword">var</span> setCommand <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">command</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;button&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>macroCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><p>从这个例子中可以看到，基本对象可以被组合成更复杂的组合对象，
组合对象又可以被组合， 这样不断递归下去，这棵树的结构可以支持任意多的复杂度。
在树最终被构造完成之后，让整颗树最终运转起来的步骤非常简单，
只需要调用最上层对象的 execute 方法。每当对最上层的对象 进行一次请求时，实际上是在对整个树进行深度优先的搜索，
而创建组合对象的程序员并不关心这些内在的细节，往这棵树里面添加一些新的节点对象是非常容易的事情。</p> <h3 id="透明性带来的安全问题"><a href="#透明性带来的安全问题" class="header-anchor">#</a> 透明性带来的安全问题</h3> <p>组合模式的透明性使得发起请求的客户不用去顾忌树中组合对象和叶对象的区别，但它们在
本质上有是区别的。</p> <p>组合对象可以拥有子节点，叶对象下面就没有子节点， 所以我们也许会发生一些误操作，
比如试图往叶对象中添加子节点。解决方案通常是给叶对象也增加 add 方法，
并且在调用这个方法时，抛出一个异常来及时提醒客户，代码如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> <span class="token function-variable function">MacroCommand</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      commandsList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">command</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>commandsList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">execute</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> command<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>command <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commandsList<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> openAcCommand <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">execute</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;打开空调&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;叶对象不能添加子节点&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>


  <span class="token keyword">var</span> macroCommand <span class="token operator">=</span> <span class="token function">MacroCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  macroCommand<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> openTvCommand <span class="token punctuation">)</span><span class="token punctuation">;</span>
  openTvCommand<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> macroCommand <span class="token punctuation">)</span> <span class="token comment">// Uncaught Error: 叶对象不能添加子节点</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="组合模式的例子-扫描文件夹"><a href="#组合模式的例子-扫描文件夹" class="header-anchor">#</a> 组合模式的例子——扫描文件夹</h3> <p>文件夹和文件之间的关系，非常适合用组合模式来描述。文件夹里既可以包含文件，又可以包含其他文件夹，
最终可能组合成一棵树，组合模式在文件夹的应用中有以下两层好处。</p> <ul><li>例如，我在同事的移动硬盘里找到了一些电子书，想把它们复制到 F 盘中的学习资料文件夹。
在复制这些电子书的时候，我并不需要考虑这批文件的类型，不管它们是单独的电子书还是被放在了文件夹中。
组合模式让 Ctrl+V、Ctrl+C 成为了一个统一的操作。</li> <li>当我用杀毒软件扫描该文件夹时，往往不会关心里面有多少文件和子文件夹，组合模式使得我们只需要操作最外层的文件夹进行扫描。</li></ul> <p>现在我们来编写代码，首先分别定义好文件夹 Folder 和文件 File 这两个类。见如下代码:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token comment">/******************************* Folder ******************************/</span>

  <span class="token keyword">var</span> <span class="token function-variable function">Folder</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token class-name">Folder</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token class-name">Folder</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">scan</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;开始扫描文件夹: &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> file<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>file <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      file<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/******************************* File ******************************/</span>

  <span class="token keyword">var</span> <span class="token function-variable function">File</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token class-name">File</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;文件下面不能再添加文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token class-name">File</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">scan</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;开始扫描文件: &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>接下来创建一些文件夹和文件对象， 并且让它们组合成一棵树，这棵树就是我们 F 盘里的 现有文件目录结构:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> folder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Folder</span><span class="token punctuation">(</span><span class="token string">&quot;学习资料&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> folder1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Folder</span><span class="token punctuation">(</span><span class="token string">&quot;JavaScript&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> folder2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Folder</span><span class="token punctuation">(</span><span class="token string">&quot;jQuery&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> file1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;JavaScript 设计模式与开发实践&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> file2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;精通 jQuery&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> file3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;重构与模式&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  folder1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>file1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  folder2<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>file2<span class="token punctuation">)</span><span class="token punctuation">;</span>

  folder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>folder1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  folder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>folder2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  folder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>file3<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>现在的需求是把移动硬盘里的文件和文件夹都复制到这棵树中，假设我们已经得到了这些文件对象:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> folder3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Folder</span><span class="token punctuation">(</span><span class="token string">&quot;Nodejs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> file4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;深入浅出 Node.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  folder3<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>file4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> file5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;JavaScript 语言精髓与编程实践&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>接下来就是把这些文件都添加到原有的树中:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  folder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>folder3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  folder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>file5<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>通过这个例子，我们再次看到客户是如何同等对待组合对象和叶对象。在添加一批文件的操作过程中，客户不用分辨它们到底是文件还是文件夹。
新增加的文件和文件夹能够很容易地添加 到原来的树结构中，和树里已有的对象一起工作。</p> <p>我们改变了树的结构，增加了新的数据，却不用修改任何一句原有的代码，这是符合开放-封闭原则的。</p> <p>运用了组合模式之后，扫描整个文件夹的操作也是轻而易举的，我们只需要操作树的最顶端对象:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  folder<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="一些值得注意的地方"><a href="#一些值得注意的地方" class="header-anchor">#</a> 一些值得注意的地方</h3> <p>在使用组合模式的时候，还有以下几个值得我们注意的地方。</p> <ul><li>组合模式不是父子关系</li></ul> <p>组合模式的树型结构容易让人误以为组合对象和叶对象是父子关系，这是不正确的。
组合模式是一种 <code>HAS-A(聚合)</code> 的关系，而不是 IS-A。组合对象包含一组叶对象，但 Leaf 并不是 Composite 的子类。
组合对象把请求委托给它所包含的所有叶对象，它们能够合作的关键是拥有相同的接口。</p> <ul><li>对叶对象操作的一致性</li></ul> <p>组合模式除了要求组合对象和叶对象拥有相同的接口之外，还有一个必要条件，就是对一组叶对象的操作必须具有一致性。</p> <p>比如公司要给全体员工发放元旦的过节费 1000 块，这个场景可以运用组合模式，
但如果公司给今天过生日的员工发送一封生日祝福的邮件，组合模式在这里就没有用武之地了，除非先把今天过生日的员工挑选出来。
只有用一致的方式对待列表中的每个叶对象的时候，才适合使用组合模式。</p> <ul><li>双向映射关系</li></ul> <p>发放过节费的通知步骤是从公司到各个部门，再到各个小组，最后到每个员工的邮箱里。
这本身是一个组合模式的好例子，但要考虑的一种情况是，也许某些员工属于多个组织架构。
比如某位架构师既隶属于开发组，又隶属于架构组，对象之间的关系并不是严格意义上的层次结构,
在这种情况下，是不适合使用组合模式的，该架构师很可能会收到两份过节费。</p> <p>这种复合情况下我们必须给父节点和子节点建立双向映射关系，
一个简单的方法是给小组和员工对象都增加集合来保存对方的引用。
但是这种相互间的引用相当复杂，而且对象之间产生了过多的耦合性，修改或者删除一个对象都变得困难，
此时我们可以引入中介者模式来管理这些对象。</p> <ul><li>用职责链模式提高组合模式性能</li></ul> <p>在组合模式中，如果树的结构比较复杂，节点数量很多，在遍历树的过程中，性能方面也许表现得不够理想。
有时候我们确实可以借助一些技巧，在实际操作中避免遍历整棵树，有一种现成的方案是借助职责链模式。
职责链模式一般需要我们手动去设置链条，但在组合模式中，父对象和子对象之间实际上形成了天然的职责链。
让请求顺着链条从父对象往子对象传递，或者是反过来从子对象往父对象传递，直到遇到可以处理该请求的对象为止，
这也是<code>职责链模式</code>的经典运用场景之一。</p> <h3 id="引用父对象"><a href="#引用父对象" class="header-anchor">#</a> 引用父对象</h3> <p>组合对象保存了它下面的子节点的引用，这是组合模式的特点，此时树结构是从上至下的。
但有时候我们需要在子节点上保持对父节点的引用，比如在组合模式中使用职责链时，有可能需要让请求从子节点往父节点上冒泡传递。
还有当我们删除某个文件的时候，实际上是从这个文件所在的上层文件夹中删除该文件的。</p> <p>现在来改写扫描文件夹的代码，使得在扫描整个文件夹之前，我们可以先移除某一个具体的文件。</p> <p>首先改写 Folder 类和 File 类，在这两个类的构造函数中，增加 this.parent 属性，
并且在调用 add 方法的时候，正确设置文件或者文件夹的父节点:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> <span class="token function-variable function">Folder</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token class-name">Folder</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    file<span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token class-name">Folder</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">scan</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;开始扫描文件夹: &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> file<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>file <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      file<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>接下来增加 Folder.prototype.remove 方法，表示移除该文件夹:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token class-name">Folder</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">remove</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> files <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>files<span class="token punctuation">,</span>
      i <span class="token operator">=</span> files<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> file <span class="token operator">=</span> files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        files<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在 File.prototype.remove 方法里，首先会判断 this.parent，如果 this.parent 为 null，
那么 这个文件夹要么是树的根节点，要么是还没有添加到树的游离节点，这时候没有节点需要从树中 4 移除，
我们暂且让 remove 方法直接 return，表示不做任何操作。</p> <p>如果 this.parent 不为 null，则说明该文件夹有父节点存在，此时遍历父节点中保存的子节 点列表，删除想要删除的子节点。</p> <p>File 类的实现基本一致:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> <span class="token function-variable function">File</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token class-name">File</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;文件下面不能再添加文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token class-name">File</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">scan</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;开始扫描文件: &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token class-name">File</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">remove</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> files <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>files<span class="token punctuation">,</span>
      i <span class="token operator">=</span> files<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> file <span class="token operator">=</span> files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        files<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>下面测试一下我们的移除文件功能:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> folder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Folder</span><span class="token punctuation">(</span><span class="token string">&quot;学习资料&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> folder1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Folder</span><span class="token punctuation">(</span><span class="token string">&quot;JavaScript&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> folder2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Folder</span><span class="token punctuation">(</span><span class="token string">&quot;jQuery&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> file1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;JavaScript 设计模式与开发实践&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> file2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;精通 jQuery&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> file3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;重构与模式&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  folder1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>file1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  folder2<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>file2<span class="token punctuation">)</span><span class="token punctuation">;</span>

  folder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>folder1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  folder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>folder2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  folder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>file3<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> folder3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Folder</span><span class="token punctuation">(</span><span class="token string">&quot;Nodejs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> file4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;深入浅出 Node.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  folder3<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>file4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> file5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;JavaScript 语言精髓与编程实践&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  folder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>folder3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  folder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>file5<span class="token punctuation">)</span><span class="token punctuation">;</span>

  file4<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  file5<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  folder<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="何时使用组合模式"><a href="#何时使用组合模式" class="header-anchor">#</a> 何时使用组合模式</h3> <p>组合模式如果运用得当，可以大大简化客户的代码。一般来说，组合模式适用于以下这两种情况。</p> <ul><li>表示对象的部分-整体层次结构。组合模式可以方便地构造一棵树来表示对象的部分-整体结构。
特别是我们在开发期间不确定这棵树到底存在多少层次的时候。在树的构造最终完成之后，只需要通过请求树的最顶层对象，
便能对整棵树做统一的操作。在组合模式中增加和删除树的节点非常方便，并且符合开放-封闭原则。</li> <li>客户希望统一对待树中的所有对象。组合模式使客户可以忽略组合对象和叶对象的区别，
客户在面对这棵树的时候，不用关心当前正在处理的对象是组合对象还是叶对象，也就不用写一堆 if、else 语句来分别处理它们。
组合对象和叶对象会各自做自己正确的事情，这是组合模式最重要的能力。</li></ul> <h3 id="小结-2"><a href="#小结-2" class="header-anchor">#</a> 小结</h3> <p>组合模式可以让我们使用树形方式创建对象的结构。我们可以把相同的操作应用在组合对象和单个对象上。
在大多数情况下，我们都可以忽略掉组合对象和单个对象之间的差别，从而用一致的方式来处理它们。</p> <p>然而，组合模式并不是完美的，它可能会产生一个这样的系统: 系统中的每个对象看起来都与其他对象差不多。
它们的区别只有在运行的时候会才会显现出来，这会使代码难以理解。
此外， 如果通过组合模式创建了太多的对象，那么这些对象可能会让系统负担不起。</p> <h2 id="装饰器模式"><a href="#装饰器模式" class="header-anchor">#</a> 装饰器模式</h2> <p>我们玩魔兽争霸的任务关时，对 15 级乱加技能点的野生英雄普遍没有好感，
而是喜欢留着技能点，在游戏的进行过程中按需加技能。同样，在程序开发中，许多时候都并不希望某个类天生就非常庞大，一次性包含许多职责。
那么我们就可以使用装饰者模式。装饰者模式可以动态地给某个对象添加一些额外的职责，而不会影响从这个类中派生的其他对象。</p> <p>在传统的面向对象语言中，给对象添加功能常常使用继承的方式，但是继承的方式并不灵活，
还会带来许多问题:一方面会导致超类和子类之间存在强耦合性，当超类改变时，子类也会随之 改变;
另一方面，继承这种功能复用方式通常被称为“白箱复用”，“白箱”是相对可见性而言的，
在继承方式中，超类的内部细节是对子类可见的，继承常常被认为破坏了封装性。</p> <p>使用继承还会带来另外一个问题，在完成一些功能复用的同时，有可能创建出大量的子类， 使子类的数量呈爆炸性增长。
比如现在有 4 种型号的自行车，我们为每种自行车都定义了一个单独的类。现在要给每种自行车都装上前灯、尾 灯和铃铛这 3 种配件。
如果使用继承的方式来给 每种自行车创建子类，则需要 4×3 = 12 个子类。
但是如果把前灯、尾灯、铃铛这些对象动态组合到自行车上面，则只需要额外增加 3 个类。</p> <p>这种给对象动态地增加职责的方式称为装饰者(decorator)模式。装饰者模式能够在不改变对象自身的基础上，在程序运行期间给对象动态地添加职责。</p> <h3 id="装饰者也是包装器"><a href="#装饰者也是包装器" class="header-anchor">#</a> 装饰者也是包装器</h3> <p>在《设计模式》成书之前，GoF 原想把装 饰者(decorator)模式称为包装器(wrapper) 模式。
从功能上而言，decorator 能很好地描述这 个模式，但从结构上看，wrapper 的说法更加贴切。
装饰者模式将一个对象嵌入另一个对象 之中，实际上相当于这个对象被另一个对象包装起来，形成一条包装链。
请求随着这条链依次传递到所有的对象，每个对象都有处理这条请求的机会。</p> <h3 id="插件式的表单验证"><a href="#插件式的表单验证" class="header-anchor">#</a> 插件式的表单验证</h3> <p>我们很多人都写过许多表单验证的代码，在一个 Web 项目中，可能存在非常多的表单，如 注册、登录、修改用户信息等。
在表单数据提交给后台之前，常常要做一些校验，比如登录的时候需要验证用户名和密码是否为空，代码如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  用户名<span class="token operator">:</span><span class="token operator">&lt;</span>input id<span class="token operator">=</span><span class="token string">&quot;username&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  密码<span class="token operator">:</span> <span class="token operator">&lt;</span>input id<span class="token operator">=</span><span class="token string">&quot;password&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;password&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>input id<span class="token operator">=</span><span class="token string">&quot;submitBtn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;提交&quot;</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> username <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      password <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      submitBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;submitBtn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> <span class="token function-variable function">formSubmit</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>username<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;用户名不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>password<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;密码不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> param <span class="token operator">=</span> <span class="token punctuation">{</span>
      username<span class="token operator">:</span> username<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      password<span class="token operator">:</span> password<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">&quot;http:// xxx.com/login&quot;</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  submitBtn<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">formSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>formSubmit 函数在此处承担了两个职责，除了提交 ajax 请求之外，还要验证用户输入的合法性。
这种代码一来会造成函数臃肿，职责混乱，二来谈不上任何可复用性。</p> <p>主要的目的是分离校验输入和提交 ajax 请求的代码，我们把校验输入的逻辑放到 validata
函数中，并且约定当 validata 函数返回 false 的时候，表示校验未通过，代码如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> <span class="token function-variable function">validata</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>username<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;用户名不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>password<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;密码不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> <span class="token function-variable function">formSubmit</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">validata</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> param <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">// 校验未通过</span>
      username<span class="token operator">:</span> username<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      password<span class="token operator">:</span> password<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">&quot;http:// xxx.com/login&quot;</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  submitBtn<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">formSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>现在的代码已经有了一些改进，我们把校验的逻辑都放到 validata 函数中，
但 formSubmit 函数的内部还要及时 validata 函数的返回值， 因为返回值的结果表明了是否通过校验。</p> <p>接下来进一步优化这段代码，使 validata 和 formSubmit 完全分离开来。首先要改写 Function.prototype.before，
如果 beforefn 的执行结果返回 false，表示不再执行后面的原函数，代码如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">before</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">beforefn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> __self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">beforefn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// beforefn 返回 false 的情况直接 return，不再执行后面的原函数 return;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token function">__self</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> <span class="token function-variable function">validata</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>username<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;用户名不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>password<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;密码不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> <span class="token function-variable function">formSubmit</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> param <span class="token operator">=</span> <span class="token punctuation">{</span>
      username<span class="token operator">:</span> username<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      password<span class="token operator">:</span> password<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">&quot;http:// xxx.com/login&quot;</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  formSubmit <span class="token operator">=</span> formSubmit<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>validata<span class="token punctuation">)</span><span class="token punctuation">;</span>
  submitBtn<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">formSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>在这段代码中，校验输入和提交表单的代码完全分离开来，它们不再有任何耦合关系，
formSubmit = formSubmit.before( validata )这句代码，如同把校验规则动态接在 formSubmit 函数之前，
validata 成为一个即插即用的函数，它甚至可以被写成配置文件的形式，这有利于我们分开维护这两个函数。
再利用策略模式稍加改造，我们就可以把这些校验规则都写成插件的形式， 用在不同的项目当中。</p> <p>** 装饰者模式的作用就是为对象动态加入行为,装饰者模式经常会形成一条长长的装饰链。**</p> <h2 id="外观模式"><a href="#外观模式" class="header-anchor">#</a> 外观模式</h2> <h2 id="享元模式"><a href="#享元模式" class="header-anchor">#</a> 享元模式</h2> <p>享元(flyweight)模式是一种用于性能优化的模式，“fly”在这里是苍蝇的意思，意为蝇量级。
享元模式的核心是运用共享技术来有效支持大量细粒度的对象。</p> <p>如果系统中因为创建了大量类似的对象而导致内存占用过高，享元模式就非常有用了。
在 JavaScript 中，浏览器特别是移动端的浏览器分配的内存并不算多，如何节省内存就成了一件非常有意义的事情。</p> <p>享元模式要求将对象的属性划分为内部状态与外部 状态(状态在这里通常指属性)。</p> <h3 id="初识享元模式"><a href="#初识享元模式" class="header-anchor">#</a> 初识享元模式</h3> <p>假设有个内衣工厂，目前的产品有 50 种男式内衣和 50 种女士内衣，为了推销产品，工厂决定生产一些塑料模特来穿上他们的内衣拍成广告照片。
正常情况下需要 50 个男模特和 50 个女 模特，然后让他们每人分别穿上一件内衣来拍照。</p> <p>不使用享元模式的情况下，在程序里也许会这样写:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> <span class="token function-variable function">Model</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sex<span class="token punctuation">,</span> underwear</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sex <span class="token operator">=</span> sex<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>underwear <span class="token operator">=</span> underwear<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token class-name">Model</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">takePhoto</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;sex=&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sex <span class="token operator">+</span> <span class="token string">&quot; underwear=&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>underwear<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> maleModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Model</span><span class="token punctuation">(</span><span class="token string">&quot;male&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;underwear&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    maleModel<span class="token punctuation">.</span><span class="token function">takePhoto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> femaleModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Model</span><span class="token punctuation">(</span><span class="token string">&quot;female&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;underwear&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    femaleModel<span class="token punctuation">.</span><span class="token function">takePhoto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>要得到一张照片，每次都需要传入 sex 和 underwear 参数，如上所述，现在一共有 50 种男内衣和 50 种女内衣，所以一共会产生 100 个对象。
如果将来生产了 10000 种内衣，那这个程序可 能会因为存在如此多的对象已经提前崩溃。</p> <p>下面我们来考虑一下如何优化这个场景。虽然有 100 种内衣，但很显然并不需要 50 个男模特和 50 个女模特。
其实男模特和女模特各自有一个就足够了，他们可以分别穿上不同的内衣来拍照。</p> <p>现在来改写一下代码，既然只需要区别男女模特，那我们先把 underwear 参数从构造函数中 移除，构造函数只接收 sex 参数:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> <span class="token function-variable function">Model</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sex <span class="token operator">=</span> sex<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token class-name">Model</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">takePhoto</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;sex= &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sex <span class="token operator">+</span> <span class="token string">&quot; underwear=&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>underwear<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>分别创建一个男模特对象和一个女模特对象:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> maleModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Model</span><span class="token punctuation">(</span> <span class="token string">'male'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> 
  femaleModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Model</span><span class="token punctuation">(</span> <span class="token string">'female'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>给男模特依次穿上所有的男装，并进行拍照:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> 
    maleModel<span class="token punctuation">.</span>underwear <span class="token operator">=</span> <span class="token string">'underwear'</span> <span class="token operator">+</span> i<span class="token punctuation">;</span> maleModel<span class="token punctuation">.</span><span class="token function">takePhoto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>同样，给女模特依次穿上所有的女装，并进行拍照:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">50</span><span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> 
    femaleModel<span class="token punctuation">.</span>underwear <span class="token operator">=</span> <span class="token string">'underwear'</span> <span class="token operator">+</span> j<span class="token punctuation">;</span> 
    femaleModel<span class="token punctuation">.</span><span class="token function">takePhoto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看到，改进之后的代码，只需要两个对象便完成了同样的功能。</p> <h3 id="内部状态和外部状态"><a href="#内部状态和外部状态" class="header-anchor">#</a> 内部状态和外部状态</h3> <p>享元模式要求将对象的属性划分为内部状态与外部 状态(状态在这里通常指属性)。
享元模式的目标是尽量减少共享对象的数量，关于如何划分内 部状态和外部状态，下面的几条经验提供了一些指引。</p> <ul><li>内部状态存储于对象内部。</li> <li>内部状态可以被一些对象共享。</li> <li>内部状态独立于具体的场景，通常不会改变。</li> <li>外部状态取决于具体的场景，并根据场景而变化，外部状态不能被共享。</li></ul> <p>这样一来，我们便可以把所有内部状态相同的对象都指定为同一个共享的对象。而外部状态可以从对象身上剥离出来，并储存在外部。</p> <p>剥离了外部状态的对象成为共享对象，外部状态在必要时被传入共享对象来组装成一个完整的对象。
虽然组装外部状态成为一个完整对象的过程需要花费一定的时间，但却可以大大减少系统中的对象数量，相比之下，这点时间或许是微不足道的。
因此，** 享元模式是一种用时间换空间的优化模式 **</p> <p>在上面的例子中，性别是内部状态，内衣是外部状态，通过区分这两种状态，大大减少了系统中的对象数量。
通常来讲，内部状态有多少种组合，系统中便最多存在多少个对象，因为性别通常只有男女两种，所以该内衣厂商最多只需要 2 个对象。</p> <p>使用享元模式的关键是如何区别内部状态和外部状态。可以被对象共享的属性通常被划分为内部状态，
如同不管什么样式的衣服，都可以按照性别不同，穿在同一个男模特或者女模特身上，模特的性别就可以作为内部状态储存在共享对象的内部。
而外部状态取决于具体的场景，并根据 场景而变化，就像例子中每件衣服都是不同的，它们不能被一些对象共享，因此只能被划分为外部状态。</p> <h3 id="享元模式的通用结构"><a href="#享元模式的通用结构" class="header-anchor">#</a> 享元模式的通用结构</h3> <p>在这个例子中还存在以下两个问题。</p> <ul><li>我们通过构造函数显式 new 出了男女两个 model 对象，在其他系统中，也许并不是一开始就需要所有的共享对象。</li> <li>给 model 对象手动设置了 underwear 外部状态，在更复杂的系统中，这不是一个最好的方式，
因为外部状态可能会相当复杂，它们与共享对象的联系会变得困难。</li></ul> <p>我们通过一个对象工厂来解决第一个问题，只有当某种共享对象被真正需要时，它才从工厂中被创建出来。
对于第二个问题，可以用一个管理器来记录对象相关的外部状态，使这些外部状态通过某个钩子和共享对象联系起来。</p> <h3 id="文件上传的例子"><a href="#文件上传的例子" class="header-anchor">#</a> 文件上传的例子</h3> <h4 id="对象爆炸"><a href="#对象爆炸" class="header-anchor">#</a> 对象爆炸</h4> <p>微云的文件上传功能虽然可以选 择依照队列，一个一个地排队上传，但也支持同时选择 2000 个文件。
每一个文件都对应着一个 JavaScript 上传对象的创建，在第一版开发中，的确往程序里同时 new 了 2000 个 upload 对象，
结果可想而知，Chrome 中还勉强能够支撑，IE 下直接进入假死状态。</p> <p>微云支持好几种上传方式，比如浏览器插件、Flash 和表单上传等，为了简化例子，我们先假设只有插件和 Flash 这两种。
不论是插件上传，还是 Flash 上传，原理都是一样的，
当用户选择了文件之后，插件和 Flash 都会通知调用 Window 下的一个全局 JavaScript 函数，它的名字是 startUpload，
用户选择的文件列表被组合成一个数组 files 塞进该函数的参数列表里，代码如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span><span class="token function-variable function">startUpload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">uploadType<span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// uploadType 区分是控件还是 flash</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> file<span class="token punctuation">;</span> <span class="token punctuation">(</span>file <span class="token operator">=</span> files<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> uploadObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Upload</span><span class="token punctuation">(</span>uploadType<span class="token punctuation">,</span> file<span class="token punctuation">.</span>fileName<span class="token punctuation">,</span> file<span class="token punctuation">.</span>fileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      uploadObj<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>id<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 给 upload 对象设置一个唯一的 id</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>当用户选择完文件之后，startUpload 函数会遍历 files 数组来创建对应的 upload 对象。
接下来定义 Upload 构造函数，它接受 3 个参数，分别是插件类型、文件名和文件大小。
这些信息都已经被插件组装在 files 数组里返回，代码如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> <span class="token function-variable function">Upload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">uploadType<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileSize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uploadType <span class="token operator">=</span> uploadType<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">=</span> fileName<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">=</span> fileSize<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dom <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token class-name">Upload</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span>
      <span class="token string">&quot;&lt;span&gt;文件名称:&quot;</span> <span class="token operator">+</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">+</span>
      <span class="token string">&quot;, 文件大小: &quot;</span> <span class="token operator">+</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">+</span>
      <span class="token string">&quot;&lt;/span&gt;&quot;</span> <span class="token operator">+</span>
      <span class="token string">'&lt;button class=&quot;delFile&quot;&gt;删除&lt;/button&gt;'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.delFile&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      that<span class="token punctuation">.</span><span class="token function">delFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>同样为了简化示例，我们暂且去掉了 upload 对象的其他功能，只保留删除文件的功能，对应的方法是 Upload.prototype.delFile。
该方法中有一个逻辑: 当被删除的文件小于 3000 KB 时，该文件将被直接删除。
否则页面中会弹出一个提示框，提示用户是否确认要删除该文件，代码如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token class-name">Upload</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">delFile</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">&lt;</span> <span class="token number">3000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">confirm</span><span class="token punctuation">(</span><span class="token string">&quot;确定要删除该文件吗? &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>接下来分别创建 3 个插件上传对象和 3 个 Flash 上传对象:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token function">startUpload</span><span class="token punctuation">(</span><span class="token string">&quot;plugin&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      fileName<span class="token operator">:</span> <span class="token string">&quot;1.txt&quot;</span><span class="token punctuation">,</span>
      fileSize<span class="token operator">:</span> <span class="token number">1000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      fileName<span class="token operator">:</span> <span class="token string">&quot;2.html&quot;</span><span class="token punctuation">,</span>
      fileSize<span class="token operator">:</span> <span class="token number">3000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      fileName<span class="token operator">:</span> <span class="token string">&quot;3.txt&quot;</span><span class="token punctuation">,</span>
      fileSize<span class="token operator">:</span> <span class="token number">5000</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">startUpload</span><span class="token punctuation">(</span><span class="token string">&quot;flash&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      fileName<span class="token operator">:</span> <span class="token string">&quot;4.txt&quot;</span><span class="token punctuation">,</span>
      fileSize<span class="token operator">:</span> <span class="token number">1000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      fileName<span class="token operator">:</span> <span class="token string">&quot;5.html&quot;</span><span class="token punctuation">,</span>
      fileSize<span class="token operator">:</span> <span class="token number">3000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      fileName<span class="token operator">:</span> <span class="token string">&quot;6.txt&quot;</span><span class="token punctuation">,</span>
      fileSize<span class="token operator">:</span> <span class="token number">5000</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h4 id="享元模式重构文件上传"><a href="#享元模式重构文件上传" class="header-anchor">#</a> 享元模式重构文件上传</h4> <p>上一节的代码是第一版的文件上传，在这段代码里有多少个需要上传的文件，就一共创建了多少个 upload 对象，接下来我们用享元模式重构它。</p> <p>首先，我们需要确认插件类型 uploadType 是内部状态，那为什么单单 uploadType 是内部状态呢?
前面讲过，划分内部状态和外部状态的关键主要有以下几点。</p> <ul><li>内部状态储存于对象内部。</li> <li>内部状态可以被一些对象共享。</li> <li>内部状态独立于具体的场景，通常不会改变。</li> <li>外部状态取决于具体的场景，并根据场景而变化，外部状态不能被共享。</li></ul> <p>在文件上传的例子里，upload 对象必须依赖 uploadType 属性才能工作，
这是因为插件上传、 Flash 上传、表单上传的实际工作原理有很大的区别，它们各自调用的接口也是完全不一样的，
必须在对象创建之初就明确它是什么类型的插件，才可以在程序的运行过程中，让它们分别调用 各自的 start、pause、cancel、del 等方法。</p> <p>实际上在微云的真实代码中，虽然插件和 Flash 上传对象最终创建自一个大的工厂类，
但它们实际上根据 uploadType 值的不同，分别是来自于两个不同类的对象。
(在目前的例子中，为了简化代码，我们把插件和 Flash 的构造函数合并成了一个。)</p> <p>一旦明确了 uploadType，无论我们使用什么方式上传，这个上传对象都是可以被任何文件共用的。
而 fileName 和 fileSize 是根据场景而变化的，每个文件的 fileName 和 fileSize 都不一样，
fileName 和 fileSize 没有办法被共享，它们只能被划分为外部状态。</p> <h4 id="剥离外部状态"><a href="#剥离外部状态" class="header-anchor">#</a> 剥离外部状态</h4> <p>明确了 uploadType 作为内部状态之后，我们再把其他的外部状态从构造函数中抽离出来，
Upload 构造函数中只保留 uploadType 参数:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> <span class="token function-variable function">Upload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">uploadType</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>uploadType <span class="token operator">=</span> uploadType<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Upload.prototype.init 函数也不再需要，因为 upload 对象初始化的工作被放在了
upload-Manager.add 函数里面，接下来只需要定义 Upload.prototype.del 函数即可:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token class-name">Upload</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">delFile</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uploadManager<span class="token punctuation">.</span><span class="token function">setExternalState</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// (1)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">&lt;</span> <span class="token number">3000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">confirm</span><span class="token punctuation">(</span><span class="token string">&quot;确定要删除该文件吗? &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在开始删除文件之前，需要读取文件的实际大小，而文件的实际大小被储存在外部管理器 uploadManager 中，
所以在这里需要通过 uploadManager.setExternalState 方法给共享对象设置正确的 fileSize，
上段代码中的(1)处表示把当前 id 对应的对象的外部状态都组装到共享对象中。</p> <h4 id="工厂进行对象实例化"><a href="#工厂进行对象实例化" class="header-anchor">#</a> 工厂进行对象实例化</h4> <p>接下来定义一个工厂来创建 upload 对象，如果某种内部状态对应的共享对象已经被创建过，
那么直接返回这个对象，否则创建一个新的对象:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> UploadFactory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> createdFlyWeightObjs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">create</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">uploadType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>createdFlyWeightObjs<span class="token punctuation">[</span>uploadType<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> createdFlyWeightObjs<span class="token punctuation">[</span>uploadType<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>createdFlyWeightObjs<span class="token punctuation">[</span>uploadType<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Upload</span><span class="token punctuation">(</span>uploadType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="管理器封装外部状态"><a href="#管理器封装外部状态" class="header-anchor">#</a> 管理器封装外部状态</h4> <p>现在我们来完善前面提到的 uploadManager 对象，它负责向 UploadFactory 提交创建对象的请求，
并用一个 uploadDatabase 对象保存所有 upload 对象的外部状态，以便在程序运行过程中给 upload 共享对象设置外部状态，代码如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> uploadManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> uploadDatabase <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> uploadType<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileSize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> flyWeightObj <span class="token operator">=</span> UploadFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>uploadType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dom<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span>
          <span class="token string">&quot;&lt;span&gt;文件名称:&quot;</span> <span class="token operator">+</span>
          fileName <span class="token operator">+</span>
          <span class="token string">&quot;, 文件大小: &quot;</span> <span class="token operator">+</span>
          fileSize <span class="token operator">+</span>
          <span class="token string">&quot;&lt;/span&gt;&quot;</span> <span class="token operator">+</span>
          <span class="token string">'&lt;button class=&quot;delFile&quot;&gt;删除&lt;/button&gt;'</span><span class="token punctuation">;</span>
        dom<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.delFile&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          flyWeightObj<span class="token punctuation">.</span><span class="token function">delFile</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
        uploadDatabase<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          fileName<span class="token operator">:</span> fileName<span class="token punctuation">,</span>
          fileSize<span class="token operator">:</span> fileSize<span class="token punctuation">,</span>
          dom<span class="token operator">:</span> dom
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> flyWeightObj<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">setExternalState</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> flyWeightObj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> uploadData <span class="token operator">=</span> uploadDatabase<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> uploadData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          flyWeightObj<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> uploadData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>然后是开始触发上传动作的 startUpload 函数:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span><span class="token function-variable function">startUpload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">uploadType<span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> file<span class="token punctuation">;</span> <span class="token punctuation">(</span>file <span class="token operator">=</span> files<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> uploadObj <span class="token operator">=</span> uploadManager<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
        <span class="token operator">++</span>id<span class="token punctuation">,</span>
        uploadType<span class="token punctuation">,</span>
        file<span class="token punctuation">.</span>fileName<span class="token punctuation">,</span>
        file<span class="token punctuation">.</span>fileSize
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>最后是测试时间，运行下面的代码后，可以发现运行结果跟用享元模式重构之前一致:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token function">startUpload</span><span class="token punctuation">(</span><span class="token string">&quot;plugin&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      fileName<span class="token operator">:</span> <span class="token string">&quot;1.txt&quot;</span><span class="token punctuation">,</span>
      fileSize<span class="token operator">:</span> <span class="token number">1000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      fileName<span class="token operator">:</span> <span class="token string">&quot;2.html&quot;</span><span class="token punctuation">,</span>
      fileSize<span class="token operator">:</span> <span class="token number">3000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      fileName<span class="token operator">:</span> <span class="token string">&quot;3.txt&quot;</span><span class="token punctuation">,</span>
      fileSize<span class="token operator">:</span> <span class="token number">5000</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">startUpload</span><span class="token punctuation">(</span><span class="token string">&quot;flash&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      fileName<span class="token operator">:</span> <span class="token string">&quot;4.txt&quot;</span><span class="token punctuation">,</span>
      fileSize<span class="token operator">:</span> <span class="token number">1000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      fileName<span class="token operator">:</span> <span class="token string">&quot;5.html&quot;</span><span class="token punctuation">,</span>
      fileSize<span class="token operator">:</span> <span class="token number">3000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      fileName<span class="token operator">:</span> <span class="token string">&quot;6.txt&quot;</span><span class="token punctuation">,</span>
      fileSize<span class="token operator">:</span> <span class="token number">5000</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>享元模式重构之前的代码里一共创建了 6 个 upload 对象，而通过享元模式重构之后，对象的数量减少为 2，
更幸运的是， 就算现在同时上传 2000 个文件，需要创建的 upload 对象数量依然是 2。</p> <h4 id="享元模式的适用性"><a href="#享元模式的适用性" class="header-anchor">#</a> 享元模式的适用性</h4> <p>享元模式是一种很好的性能优化方案，但它也会带来一些复杂性的问题，从前面两组代码的比较可以看到，使用了享元模式之后，
我们需要分别多维护一个 factory 对象和一个 manager 对 象，在大部分不必要使用享元模式的环境下，这些开销是可以避免的。</p> <p>享元模式带来的好处很大程度上取决于如何使用以及何时使用，一般来说，以下情况发生时 便可以使用享元模式。</p> <ul><li>对象的大多数状态都可以变为外部状态。</li> <li>一个程序中使用了大量的相似对象。</li> <li>由于使用了大量对象，造成很大的内存开销。</li> <li>剥离出对象的外部状态之后，可以用相对较少的共享对象取代大量对象。
可以看到，文件上传的例子完全符合这四点。</li></ul> <h3 id="再谈内部状态和外部状态"><a href="#再谈内部状态和外部状态" class="header-anchor">#</a> 再谈内部状态和外部状态</h3> <p>如果顺利的话，通过前面的例子我们已经了解了内部状态和外部状态的概念以及享元模式的工作原理。
我们知道，实现享元模式的关键是把内部状态和外部状态分离开来。
有多少种内部状态的组合，系统中便最多存在多少个共享对象，而外部状态储存在共享对象的外部，
在必要时被传入共享对象来组装成一个完整的对象。现在来考虑两种极端的情况，即对象没有外部状态和没有内部状态的时候。</p> <h3 id="没有内部状态的享元"><a href="#没有内部状态的享元" class="header-anchor">#</a> 没有内部状态的享元</h3> <p>在文件上传的例子中，我们分别进行过插件调用和 Flash 调用，即 startUpload( 'plugin', [] ) 和 startUpload( flash, [] )，
导致程序中创建了内部状态不同的两个共享对象。也许你会奇怪，在文件上传程序里，一般都会提前通过特性检测来选择一种上传方式，
如果浏览器支持插件就用插件上传，如果不支持插件，就用 Flash 上传。那么，什么情况下既需要插件上传又需要 Flash 上传呢?</p> <p>实际上这个需求是存在的，很多网盘都提供了极速上传(控件)与普通上传(Flash)两种模式，
如果极速上传不好使(可能是没有安装控件或者控件损坏)，用户还可以随时切换到普通上传模式，
所以这里确实是需要同时存在两个不同的 upload 共享对象。</p> <p>但不是每个网站都必须做得如此复杂，很多小一些的网站就只支持单一的上传方式。假设我们是这个网站的开发者，不需要考虑极速上传与普通上传之间的切换，这意味着在之前的代码中
作为内部状态的 uploadType 属性是可以删除掉的。 在继续使用享元模式的前提下，构造函数 Upload 就变成了无参数的形式:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> <span class="token function-variable function">Upload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其他属性如 fileName、fileSize、dom 依然可以作为外部状态保存在共享对象外部。
在 uploadType 作为内部状态的时候，它可能为控件，也可能为 Flash，所以当时最多可以组合出两个共享对象。
而现在已经没有了内部状态，这意味着只需要唯一的一个共享对象。现在我们要改写 创建享元对象的工厂，代码如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> UploadFactory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> uploadObj<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">create</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> uploadObj<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>uploadObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>管理器部分的代码不需要改动，还是负责剥离和组装外部状态。
可以看到，当对象没有内部 状态的时候，生产共享对象的工厂实际上变成了一个单例工厂。
虽然这时候的共享对象没有内部状态的区分，但还是有剥离外部状态的过程，我们依然倾向于称之为享元模式。</p> <h3 id="没有外部状态的享元"><a href="#没有外部状态的享元" class="header-anchor">#</a> 没有外部状态的享元</h3> <p>网上许多资料中，经常把 Java 或者 C#的字符串看成享元，这种说法是否正确呢?我们看看
下面这段 Java 代码，来分析一下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span> <span class="token parameter">String args<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">)</span><span class="token punctuation">{</span> 
      String a1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span> <span class="token string">&quot;a&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      String a2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span> <span class="token string">&quot;a&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> a1 <span class="token operator">==</span> a2 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
    <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在这段 Java 代码里，分别 new 了两个字符串对象 a1 和 a2。intern 是一种对象池技术， new String(&quot;a&quot;).intern()的含义如下。</p> <ul><li>如果值为 a 的字符串对象已经存在于对象池中，则返回这个对象的引用。</li> <li>反之，将字符串 a 的对象添加进对象池，并返回这个对象的引用。</li></ul> <p>所以 a1 == a2 的结果是 true，但这并不是使用了享元模式的结果，享元模式的关键是区别内部状态和外部状态。
享元模式的过程是剥离外部状态，并把外部状态保存在其他地方，在合适的时刻再把外部状态组装进共享对象。
这里并没有剥离外部状态的过程，a1 和 a2 指向的完全就是同一个对 象，所以如果没有外部状态的分离，
即使这里使用了共享的技术，但并不是一个纯粹的享元模式。</p> <h3 id="对象池"><a href="#对象池" class="header-anchor">#</a> 对象池</h3> <p>我们在前面已经提到了 Java 中 String 的对象池，下面就来学习这种共享的技术。
对象池维护一个装载空闲对象的池子，如果需要对象的时候，不是直接 new，而是转从对象池里获取。
如果对象池里没有空闲对象，则创建一个新的对象，当获取出的对象完成它的职责之后， 再进入池子等待被下次获取。</p> <p>对象池的原理很好理解，比如我们组人手一本《JavaScript 权威指南》，从节约的角度来讲， 这并不是很划算，
因为大部分时间这些书都被闲置在各自的书架上，所以我们一开始就只买一本， 或者一起建立一个小型图书馆(对象池)，
需要看书的时候就从图书馆里借，看完了之后再把书还回图书馆。
如果同时有三个人要看这本书，而现在图书馆里只有两本，那我们再马上去书店买 一本放入图书馆。</p> <p>对象池技术的应用非常广泛，HTTP 连接池和数据库连接池都是其代表应用。
在 Web 前端开发中，对象池使用最多的场景大概就是跟 DOM 有关的操作。
很多空间和时间都消耗在了 DOM 节点上，如何避免频繁地创建和删除 DOM 节点就成了一个有意义的话题。</p> <h4 id="对象池实现"><a href="#对象池实现" class="header-anchor">#</a> 对象池实现</h4> <p>假设我们在开发一个地图应用，地图上经常会出现一些标志地名的小气泡，我们叫它 toolTip。</p> <p><img src="/assets/images/map-tooltip.png" alt=""></p> <p>在搜索我家附近地图的时候，页面里出现了 2 个小气泡。当我再搜索附近的兰州拉面馆时， 页面中出现了 6 个小气泡。
按照对象池的思想，在第二次搜索开始之前，并不会把第一次创建的 2 个小气泡删除掉，而是把它们放进对象池。
这样在第二次的搜索结果页面里，我们只需要再创 建 4 个小气泡而不是 6 个。</p> <p><img src="/assets/images/map-tooltip-2.png" alt=""></p> <p>先定义一个获取小气泡节点的工厂，作为对象池的数组成为私有属性被包含在工厂闭包里，
这个工厂有两个暴露对外的方法，create 表示获取一个 div 节点，recover 表示回收一个 div 节点:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> toolTipFactory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> toolTipPool <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// toolTip 对象池</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">create</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>toolTipPool<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果对象池为空</span>
          <span class="token keyword">var</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建一个 dom</span>
          document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">return</span> div<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果对象池里不为空</span>
          <span class="token keyword">return</span> toolTipPool<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">recover</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">tooltipDom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> toolTipPool<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tooltipDom<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对象池回收 dom</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>现在把时钟拨回进行第一次搜索的时刻，目前需要创建 2 个小气泡节点，为了方便回收，用一个数组 ary 来记录它们:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> ary <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    str <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;A&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;B&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> toolTip <span class="token operator">=</span> toolTipFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    toolTip<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> str<span class="token punctuation">;</span>
    ary<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>toolTip<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>如果你愿意稍稍测试一下，可以看到页面中出现了 innerHTML 分别为 A 和 B 的两个 div 节点。</p> <p>接下来假设地图需要开始重新绘制，在此之前要把这两个节点回收进对象池:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> toolTip<span class="token punctuation">;</span> <span class="token punctuation">(</span>toolTip <span class="token operator">=</span> ary<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    toolTipFactory<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>toolTip<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>再创建 6 个小气泡:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> str<span class="token punctuation">;</span> <span class="token punctuation">(</span>str <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;A&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;B&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;C&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;D&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;E&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;F&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> toolTip <span class="token operator">=</span> toolTipFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 简单的修改 html</span>
    toolTip<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> str<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>现在再测试一番，页面中出现了内容分别为 A、B、C、D、E、F 的 6 个节点，上一次创建 好的节点被共享给了下一次操作。
对象池跟享元模式的思想有点相似，虽然 innerHTML 的值 A、B、 C、D 等也可以看成节点的外部状态，
但在这里我们并没有主动分离内部状态和外部状态的过程。</p> <h4 id="通用对象池实现"><a href="#通用对象池实现" class="header-anchor">#</a> 通用对象池实现</h4> <p>我们还可以在对象池工厂里，把创建对象的具体过程封装起来，实现一个通用的对象池:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> iframeFactory <span class="token operator">=</span> <span class="token function">objectPoolFactory</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;iframe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span>
    iframe<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      iframe<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 防止 iframe 重复加载的 bug</span>
      iframeFactory<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// iframe 加载完成之后回收节点</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> iframe<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>现在利用 objectPoolFactory 来创建一个装载一些 iframe 的对象池:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> iframe1 <span class="token operator">=</span> iframeFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  iframe1<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;http:// baidu.com&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> iframe2 <span class="token operator">=</span> iframeFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  iframe2<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;http:// QQ.com&quot;</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> iframe3 <span class="token operator">=</span> iframeFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    iframe3<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;http:// 163.com&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>对象池是另外一种性能优化方案，它跟享元模式有一些相似之处，但没有分离内部状态和外部状态这个过程。
本章用享元模式完成了一个文件上传的程序，其实也可以用对象池+事件委托 来代替实现。</p> <h3 id="小结-3"><a href="#小结-3" class="header-anchor">#</a> 小结</h3> <p>享元模式是为解决性能问题而生的模式，这跟大部分模式的诞生原因都不一样。在一个存在
大量相似对象的系统中，享元模式可以很好地解决大量对象带来的性能问题。</p> <h2 id="代理模式"><a href="#代理模式" class="header-anchor">#</a> 代理模式</h2> <p><a href="/assets/pdf/JavaScript%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B8%8E%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.pdf">JavaScript 设计模式与开发实践-代理模式</a></p> <p>为你想访问的对象增加一个包装，以后再使用中都会访问这个包装，包装在与对象相连。</p> <p>代理模式是一种非常有意义的模式，在生活中可以找到很多代理模式的场景。比如，明星都有经纪人作为代理。
如果想请明星来办一场商业演出，只能联系他的经纪人。经纪人会把商业演出的细节和报酬都谈好之后，再把合同交给明星签。</p> <p>代理模式的关键是，当客户不方便直接访问一个对象或者不满足需要的时候，提供一个替身对象来控制对这个对象的访问，
客户实际上访问的是替身对象。替身对象对请求做出一些处理之后，再把请求转交给本体对象。</p> <h3 id="保护代理和虚拟代理"><a href="#保护代理和虚拟代理" class="header-anchor">#</a> 保护代理和虚拟代理</h3> <p>保护代理用于控制不同权限的对象对目标对象的访问。</p> <p>经纪人会把一些演出舞台地点不好的、报酬太低的合同给直接 pass 掉，这是 <code>保护代理</code>。 演员可以不被这些麻烦事给影响。</p> <p><code>保护代理</code> 用于控制不同权限的对象对目标对象的访问。</p> <p>请一位明星表演需要花费很多的钱， 所以一般只有在真正需要的时候才会请明星，这是 <code>虚拟代理</code>。</p> <p><code>虚拟代理</code> 把一些开销很大的对象，延迟到真正需要它的时候才去创建。</p> <p>代理模式的变体种类非常多，限于篇幅及其在 JavaScript 中的适用性，本章只简约介绍一下
这些代理，就不一一详细展开说明了。</p> <ul><li>防火墙代理:控制网络资源的访问，保护主题不让“坏人”接近。</li> <li>远程代理:为一个对象在不同的地址空间提供局部代表，在 Java 中，远程代理可以是另一个虚拟机中的对象。</li> <li>保护代理:用于对象应该有不同访问权限的情况。</li> <li>智能引用代理:取代了简单的指针，它在访问对象时执行一些附加操作，比如计算一个对象被引用的次数。</li> <li>写时复制代理:通常用于复制一个庞大对象的情况。写时复制代理延迟了复制的过程，
当对象被真正修改时，才对它进行复制操作。写时复制代理是虚拟代理的一种变体，DLL (操作系统中的动态链接库)是其典型运用场景。</li></ul> <h3 id="小结-4"><a href="#小结-4" class="header-anchor">#</a> 小结</h3> <p>代理模式包括许多小分类，在 JavaScript 开发中最常用的是虚拟代理和缓存代理。
虽然代理模式非常有用，但我们在编写业务代码的时候，往往不需要去预先猜测是否需要使用代理模式。
当真正发现不方便直接访问某个对象的时候，再编写代理也不迟。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/26/2020, 2:00:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/design-patterns/creation-type/creation-type.html" class="prev">
        创建型
      </a></span> <span class="next"><a href="/design-patterns/j2ee/j2ee.html">
        j2ee
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.01dca14b.js" defer></script><script src="/assets/js/2.bffc4eaa.js" defer></script><script src="/assets/js/29.15ed9b47.js" defer></script>
  </body>
</html>
